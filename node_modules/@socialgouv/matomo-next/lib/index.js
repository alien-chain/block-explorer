"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.init = exports.push = void 0;
var router_1 = __importDefault(require("next/router"));
var isExcludedUrl = function (url, patterns) {
    var excluded = false;
    patterns.forEach(function (pattern) {
        if (pattern.exec(url) !== null) {
            excluded = true;
        }
    });
    return excluded;
};
// to push custom events
function push(args) {
    if (!window._paq) {
        window._paq = [];
    }
    window._paq.push(args);
}
exports.push = push;
var startsWith = function (str, needle) {
    // eslint-disable-next-line @typescript-eslint/prefer-string-starts-ends-with
    return str.substring(0, needle.length) === needle;
};
// initialize the tracker
function init(_a) {
    var url = _a.url, siteId = _a.siteId, _b = _a.jsTrackerFile, jsTrackerFile = _b === void 0 ? "matomo.js" : _b, _c = _a.phpTrackerFile, phpTrackerFile = _c === void 0 ? "matomo.php" : _c, _d = _a.excludeUrlsPatterns, excludeUrlsPatterns = _d === void 0 ? [] : _d;
    window._paq = window._paq !== null ? window._paq : [];
    if (!url) {
        console.warn("Matomo disabled, please provide matomo url");
        return;
    }
    var previousPath = "";
    // order is important -_- so campaign are detected
    var excludedUrl = typeof window !== "undefined" &&
        isExcludedUrl(window.location.pathname, excludeUrlsPatterns);
    if (excludedUrl) {
        if (typeof window !== "undefined") {
            console.log("matomo: exclude track " + window.location.pathname);
        }
    }
    else {
        push(["trackPageView"]);
    }
    push(["enableLinkTracking"]);
    push(["setTrackerUrl", url + "/" + phpTrackerFile]);
    push(["setSiteId", siteId]);
    /**
     * for initial loading we use the location.pathname
     * as the first url visited.
     * Once user navigate across the site,
     * we rely on Router.pathname
     */
    var scriptElement = document.createElement("script");
    var refElement = document.getElementsByTagName("script")[0];
    scriptElement.type = "text/javascript";
    scriptElement.async = true;
    scriptElement.defer = true;
    scriptElement.src = url + "/" + jsTrackerFile;
    if (refElement.parentNode) {
        refElement.parentNode.insertBefore(scriptElement, refElement);
    }
    previousPath = location.pathname;
    router_1.default.events.on("routeChangeComplete", function (path) {
        var routeExcludedUrl = isExcludedUrl(path, excludeUrlsPatterns);
        if (routeExcludedUrl) {
            console.log("matomo: exclude track " + path);
            return;
        }
        // We use only the part of the url without the querystring to ensure piwik is happy
        // It seems that piwik doesn't track well page with querystring
        var pathname = path.split("?")[0];
        // In order to ensure that the page title had been updated,
        // we delayed pushing the tracking to the next tick.
        setTimeout(function () {
            var q = router_1.default.query.q;
            if (previousPath) {
                push(["setReferrerUrl", "" + previousPath]);
            }
            push(["setCustomUrl", pathname]);
            push(["setDocumentTitle", document.title]);
            push(["deleteCustomVariables", "page"]);
            if (startsWith(pathname, "/recherche") ||
                startsWith(pathname, "/search")) {
                push(["trackSiteSearch", q !== null && q !== void 0 ? q : ""]);
            }
            else {
                push(["trackPageView"]);
            }
            previousPath = pathname;
        }, 0);
    });
}
exports.init = init;
exports.default = init;
//# sourceMappingURL=index.js.map